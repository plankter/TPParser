# Title: sMC tumor data analysis, CyTOF
# Version: 2.0
# Date: 2019-03-29
# Authors: S.C. CyTOF Operator
# Reviewer: R.C. IMC Operator
# Approver: B.B Lablead

# Introduction: 
This SOP describes how the suspension mass cytometry data are analyzed in order to identify the main cell types present in the sample of interest and do an in depth analysis on the tumor compartment. In this context, the frequencies and surface expression marker are compared with a set of reference samples.
The “sMC_M_Analysis.Rmd” script used to run the pre-processing steps is available on the following github repository : https://github.com/BodenmillerGroup/TumorProfiler. A branch will be generated for each sample analyzed in the context of the tumor profiler. 
The System package info will be available on this branch as well.

# Analysis: Data transformation
- Description: load FCS files, convert them to a data.table and arsinh the data
- Reference data used: NA
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: gated cytof files generated by the pre-processing script
- Config/Arguments: cofactor for arcsinh set to 5

# Analysis: tSNE analysis across all samples and cell types [1]
- Description: Dimensionality reduction is performed on the transformed data using the t-distributed stochastic Neighbor embedding (tSNE) algorithm with the RtSNE package. All the antibody channels are used in the analysis
- Reference data used: NA
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table
- Config/Arguments: number of cell per sample: 10000;seed:200
## Not uploaded: tSNE_M.rdata
- Format: R data output in rdata format
- Content description: cell id in individual row with tSNE-1 and tSNE-2 coordinates in 2 columns
## Not uploaded: samples_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by samples (including sample of interest and references)

# Analysis: Main cell type classification
- Description: random forest classification of immune/tumor/fibroblast/endothelial cells
- Reference data used: cell_type_rf.rdata available in https://github.com/BodenmillerGroup/TumorProfiler/.
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table
- Config/Arguments: NA
## Not uploaded: cluster_type_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by cell type according to random forest classification

# Analysis: tSNE analysis across all cell types per sample of interest
- Description: Dimensionality reduction is performed on the transformed data using the t-distributed stochastic Neighbor embedding (tSNE) algorithm with the RtSNE package for each sample of interest. All the antibody channels are used in the analysis
- Reference data used: NA
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table
- Config/Arguments: number of cell per sample: 10000;seed:200
## Not uploaded: all_cell_sample_tSNE_M.rdata
- Format: R data output in rdata format
- Content description: cell id in individual row with tSNE-1 and tSNE-2 coordinates in 2 columns
## all_cell_marker_expression_sample_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by marker for the sample of interest only
## all_cell_classified_sample_tSNE_M.fcs
- Format: table in the fcs format
- Content description: for each cell (columns), marker expression, tSNE values and cell type  according to the random forest classifier.
## all_cell_classified_sample_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by cell type for the sample of interest only
## cell_type_composition_sample_M.png
- Format: image in the png format
- Content description: histogram showing the frequency of each cell type
## cell_type_composition_sample_M.csv
- Format: table in the csv format
- Content description: single row showing the sample of interest with the cell types in column. variable displayed is cell type frequency

# Analysis: tSNE visualization of tumor cells only across all the samples and references
- Description: Run a tSNE analysis on all cell classified as tumor cells with the random forest classifier an visualize the clusters on a tSNE map. 
- Reference data used: NA
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table with tumor cells only from all sample
- Config/Arguments: number of cell per sample: 5000;seed:200
## Not uploaded: tumor_cell_tSNE_M.rdata
- Format: R data output in rdata format
- Content description: cell id in individual row with tSNE-1 and tSNE-2 coordinates in 2 columns
## Not uploaded: tumor_cell_marker_expression_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by marker for tumor cells across all samples and references
## Not uploaded: tumor_cell_samples_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by samples for tumor cells across all samples and references

# Analysis: identification of tumor cell clusters across all the samples and references [2]
- Description: Run a PhenoGraph cluster on all cell classified as tumor cells with the random forest classifier an visualize the clusters on a tSNE map. 
- Reference data used: NA
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table with tumor cell only from all samples
- Config/Arguments: seed:200, k:50
## Not uploaded: tumor_cell_PG_M.rdata
- Format: R data output in rdata format
- Content description: cell id in individual row with PG cluster id in one column
## Not uploaded: tumor_cell_PG_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by clusters for tumor cells across all samples and references

# Analysis: tSNE visualization of tumor cells in the sample of interest
- Description: Run a tSNE analysis on all cell classified as tumor cells in the sample of interest
- Reference data used: NA
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table with tumor cell only for the sample of interest
- Config/Arguments: number of cell per sample: all cells;seed:200
## Not uploaded: tumor_cell_sample_tSNE_M.rdata
- Format: R data output in rdata format
- Content description: cell id in individual row with tSNE-1 and tSNE-2 coordinates in 2 columns
## tumor_cell_marker_expression_sample_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by marker expression for tumor cells in the sample of interest
## tumor_cell_PG_sample_tSNE_M.png
- Format: image in the png format
- Content description: tSNE plot colored by cluster for tumor cells of the sample of interest
## tumor_cell_sample_PG_tSNE_M.fcs
- Format: table in a fcs format
- Content description: cell id on each line, marker in columns, median as value. tSNE-1 and tSNE-2 coordinates and PG id are added as extra columns

# Analysis: cluster frequency per sample
- Description: Calculate cluster frequency per sample
- Reference data used: NA
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table with PhenoGraph cluster id for each cell
- Config/Arguments: NA
## tumor_composition_sample_M.csv
- Format: table as a csv file
- Content description: sample of interest in row and cluster id in column with frequency as values
## tumor_composition_sample_M.png
- Format: image in the png format
- Content description: stacked histogram showing the frequency of cluster composing the sample of interest

# Analysis: cluster marker median per sample
- Description: Calculate marker median expression per sample
- Reference data used: expression observed on reference cell lines and tumor samples included in the same dataset
- Script/Software: https://github.com/BodenmillerGroup/TumorProfiler/sMC_M_analysis_v2.0.Rmd
- Input: transformed data table with PhenoGraph cluster id for each cell
- Config/Arguments: NA
## tumor_marker_expression_per_cluster_vs_ref_M.csv
- Format: table as a csv file
- Content description: cluster id in row and marker expression in column with median as values
## tumor_marker_expression_per_cluster_vs_ref_M.png
- Format: image in the png format
- Content description : dotplot showing median marker expression for each cluster present in the sample of interest where the size of the dot is proportional of the size of the cluster. In backgroung, expression level found in reference is displayed as a boxplot.

# Literature:
[1] A.E.A. et al, Nat Biotechnol. 2013 Jun;31(6):545-52
[2] J.L et al, Cell. 2015 Jul 2;162(1):184-97

# History:
- 2.0;2019-03-28; added cell classifier for main cell type identification and format adapted to the new version
- 1.0; 2018-12-09; initial version